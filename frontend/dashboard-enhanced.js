// Enhanced Dashboard with Real-time Analytics and Fixed Validation
// Use shared API_BASE if provided by admin-dashboard.js, fallback to same-origin
var API_BASE = (window.API_BASE) ? window.API_BASE : '/api';

// Global variables for real-time updates
let chartInstances = {};
let realTimeInterval = null;
let settings = {
  darkMode: false,
  sidebarColor: '#23234a',
  realtimeEnabled: true,
  refreshMs: 30000
};

// Enhanced Certificate Validation - Fixed
async function validateCertificate() {
  const uuid = document.getElementById('validateUUID')?.value.trim();
  const resultDiv = document.getElementById('validateResult');
  
  if (!uuid) {
    showErrorMessage('Please enter a Certificate UUID.');
    return;
  }
  
  if (!resultDiv) {
    showErrorMessage('Validation result container not found.');
    return;
  }

  resultDiv.innerHTML = '<div class="loading">Validating...</div>';

  try {
    console.log('Enhanced validation - UUID:', uuid);
    const response = await authFetch(`${API_BASE}/certificates/validate/${uuid}`);
    const data = await response.json();
    console.log('Enhanced validation response:', data);
    
    if (data.valid) {
      resultDiv.innerHTML = `
        <div class="validation-success">
          <h4>‚úÖ Certificate Valid - Generated Through This System!</h4>
          <div class="certificate-details">
            <p><strong>Student:</strong> ${data.certificate.student}</p>
            <p><strong>Course:</strong> ${data.certificate.course}</p>
            <p><strong>Institute:</strong> ${data.certificate.institute}</p>
            <p><strong>Date:</strong> ${data.certificate.date}</p>
            <p><strong>UUID:</strong> ${data.certificate.uuid}</p>
            <p><strong>Generated by Admin:</strong> ${data.certificate.generatedByAdmin ? 'Yes' : 'No'}</p>
            <p><strong>Validation Count:</strong> ${data.validation.validationCount}</p>
            <p><strong>Validated At:</strong> ${new Date(data.validation.validatedAt).toLocaleString()}</p>
            <p><strong>Status:</strong> <span class="status-issued">Verified</span></p>
            ${data.institute ? `
              <p><strong>Institute Contact:</strong> ${data.institute.email}</p>
              <p><strong>Institute Location:</strong> ${data.institute.location}</p>
              <p><strong>Institute Status:</strong> ${data.institute.status}</p>
            ` : ''}
            ${data.certificate.blockchain ? `
              <p><strong>Blockchain Anchored:</strong> Yes (${data.certificate.blockchain.network || 'simulated'})</p>
            ` : ''}
          </div>
        </div>
      `;
    } else {
      resultDiv.innerHTML = `
        <div class="validation-error">
          <h4>‚ùå Certificate Invalid!</h4>
          <p>${data.message}</p>
          <p><strong>Error:</strong> ${data.error || 'Unknown error'}</p>
        </div>
      `;
    }
  } catch (error) {
    console.error('Validation error:', error);
    resultDiv.innerHTML = `
      <div class="validation-error">
        <h4>‚ùå Server Error!</h4>
        <p>Could not validate certificate. Please try again later.</p>
      </div>
    `;
  }
}

// Real-time Analytics Dashboard
function initializeRealTimeDashboard() {
  setupAdvancedFilters();
  loadInitialMetrics();
  loadSettings();
  startRealTimeUpdates();
  initializeCharts();
  initSocket();
}

function setupAdvancedFilters() {
  const dateRange = document.getElementById('dateRange');
  if (dateRange) {
    dateRange.addEventListener('change', generateAdvancedReport);
  }
  
  populateInstituteFilter();
}

async function loadInitialMetrics() {
  try {
    const response = await authFetch(`${API_BASE}/stats/counts`);
    const data = await response.json();
    
    updateDashboardMetrics(data);
  } catch (error) {
    console.error('Error loading metrics:', error);
    // Use fallback data
    updateDashboardMetrics({ totalCertificates: 0, totalInstitutes: 0 });
  }
}

function updateDashboardMetrics(data) {
  const certCount = document.getElementById('certCount');
  const instCount = document.getElementById('instCount');
  
  if (certCount) certCount.textContent = data.totalCertificates || 0;
  if (instCount) instCount.textContent = data.totalInstitutes || 0;
}

function startRealTimeUpdates() {
  if (realTimeInterval) clearInterval(realTimeInterval);
  realTimeInterval = setInterval(async () => {
    if (!settings.realtimeEnabled) return;
    try {
      const response = await authFetch(`${API_BASE}/stats/counts`);
      const data = await response.json();
      updateDashboardMetrics(data);
    } catch (error) {
      console.error('Real-time update error:', error);
    }
  }, settings.refreshMs);
  
  // Update live activity feed every 5 seconds
  setInterval(() => settings.realtimeEnabled && updateLiveActivityFeed(), 5000);
}

function initSocket() {
  if (!window.io) return;
  const socket = window.io(window.API_HOST || undefined);

  socket.on('connect', () => {});

  // Security Center real-time metrics
  socket.on('security:metrics', (payload) => {
    const activeSessions = document.getElementById('activeSessions');
    const failedLogins = document.getElementById('failedLogins');
    const suspicious = document.getElementById('suspiciousActivity');
    const anchored = document.getElementById('anchoredCerts');
    const networkStatus = document.getElementById('networkStatus');
    const lastSync = document.getElementById('lastSync');
    if (activeSessions) activeSessions.textContent = String(payload.activeSessions ?? 0);
    if (failedLogins) failedLogins.textContent = String(payload.failedLogins ?? 0);
    if (suspicious) suspicious.textContent = String(payload.suspiciousActivity ?? 0);
    if (anchored) anchored.textContent = String(payload.anchoredCerts ?? 0);
    if (networkStatus) networkStatus.textContent = payload.networkStatus || 'Connected';
    if (lastSync) lastSync.textContent = new Date(payload.lastSync).toLocaleTimeString();
  });

  socket.on('security:failedLogin', () => {
    const failedLogins = document.getElementById('failedLogins');
    if (failedLogins) {
      failedLogins.textContent = String(parseInt(failedLogins.textContent || '0', 10) + 1);
    }
    appendSecurityAlert('Failed admin login detected.');
  });

  socket.on('security:loginSuccess', (payload) => {
    appendSecurityAlert(`Admin ${payload.admin || ''} logged in successfully.`);
  });
}

function appendSecurityAlert(message) {
  const container = document.getElementById('securityAlertsList');
  if (!container) return;
  const item = document.createElement('div');
  item.className = 'alert-item';
  const time = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
  item.innerHTML = `<span class="alert-time">${time}</span><span class="alert-text">${message}</span>`;
  container.insertBefore(item, container.firstChild);
  if (container.children.length > 10) container.removeChild(container.lastChild);
}

async function refreshAnalyticsLight() {
  try {
    const filters = getAdvancedFilters();
    const res = await authFetch(`${API_BASE}/stats/analytics?${filters}`);
    const analytics = await res.json();
    updateCertificateTrendChart(analytics);
    updateCourseDistributionChart(analytics);
  } catch (e) {}
}

// Settings handlers
function loadSettings() {
  try {
    const saved = JSON.parse(localStorage.getItem('dashboardSettings') || '{}');
    settings = { ...settings, ...saved };
  } catch {}
  applyTheme();
  wireSettingsUI();
}

function wireSettingsUI() {
  const darkToggle = document.getElementById('themeToggle');
  const sidebarColor = document.getElementById('dashboardColor');
  const realtimeToggle = document.getElementById('realtimeToggle');
  const refreshInterval = document.getElementById('refreshInterval');

  if (darkToggle) {
    darkToggle.checked = settings.darkMode;
    darkToggle.onchange = () => {
      settings.darkMode = darkToggle.checked;
      persistSettings();
      applyTheme();
    };
  }

  if (sidebarColor) {
    sidebarColor.value = settings.sidebarColor;
    sidebarColor.oninput = () => {
      settings.sidebarColor = sidebarColor.value;
      persistSettings();
      applyTheme();
    };
  }

  if (realtimeToggle) {
    realtimeToggle.checked = settings.realtimeEnabled;
    realtimeToggle.onchange = () => {
      settings.realtimeEnabled = realtimeToggle.checked;
      persistSettings();
    };
  }

  if (refreshInterval) {
    refreshInterval.value = String(settings.refreshMs);
    refreshInterval.onchange = () => {
      settings.refreshMs = parseInt(refreshInterval.value, 10);
      persistSettings();
      startRealTimeUpdates();
    };
  }
}

function persistSettings() {
  localStorage.setItem('dashboardSettings', JSON.stringify(settings));
}

function applyTheme() {
  const body = document.body;
  const sidebar = document.querySelector('.sidebar');
  if (settings.darkMode) {
    body.classList.add('dark');
  } else {
    body.classList.remove('dark');
  }
  if (sidebar) sidebar.style.background = settings.sidebarColor;
}

// Advanced analytics button handlers
window.generateAdvancedReport = async function() {
  await generateAdvancedReport();
}

window.exportAdvancedReport = function() {
  exportReport();
}

window.exportAdvancedExcel = function() {
  exportExcel();
}

window.saveReportTemplate = function() {
  showSuccessMessage('Template saved.');
}

window.toggleChartType = function(canvasId, type) {
  const chart = chartInstances[canvasId];
  if (!chart) return;
  chart.config.type = type === 'area' ? 'line' : type;
  if (type === 'area') {
    const ds = chart.config.data.datasets[0];
    ds.fill = true;
    ds.backgroundColor = 'rgba(102, 126, 234, 0.1)';
  }
  chart.update();
}

// removed live activity feed updater

async function generateAdvancedReport() {
  try {
    showLoadingState();
    
    const filters = getAdvancedFilters();
    const analytics = await fetchAdvancedAnalytics(filters);
    
    updateAdvancedMetrics(analytics);
    updateAdvancedCharts(analytics);
    
    hideLoadingState();
  } catch (error) {
    console.error('Error generating report:', error);
    hideLoadingState();
    showErrorMessage('Failed to generate report. Please try again.');
  }
}

function getAdvancedFilters() {
  const dateRange = document.getElementById('dateRange')?.value;
  const startDate = document.getElementById('startDate')?.value;
  const endDate = document.getElementById('endDate')?.value;

  let queryParams = new URLSearchParams();
  
  if (dateRange === 'custom' && startDate && endDate) {
    queryParams.append('startDate', startDate);
    queryParams.append('endDate', endDate);
  } else if (dateRange && dateRange !== 'custom') {
    const end = new Date();
    const start = new Date();
    start.setDate(start.getDate() - parseInt(dateRange));
    queryParams.append('startDate', start.toISOString().split('T')[0]);
    queryParams.append('endDate', end.toISOString().split('T')[0]);
  }

  return queryParams;
}

async function fetchAdvancedAnalytics(filters) {
  try {
    const [analyticsRes, revenueRes] = await Promise.all([
      authFetch(`${API_BASE}/stats/analytics?${filters}`),
      authFetch(`${API_BASE}/institutes/revenue?${filters}`)
    ]);

    return {
      analytics: await analyticsRes.json(),
      revenue: await revenueRes.json()
    };
  } catch (error) {
    console.error('Error fetching analytics:', error);
    return getMockAnalyticsData();
  }
}

function getMockAnalyticsData() {
  return {
    analytics: {
      currentPeriod: { totalCertificates: 150, growthRate: 15.2 },
      dailyTrends: [
        { _id: { year: 2024, month: 1, day: 15 }, count: 25 },
        { _id: { year: 2024, month: 1, day: 16 }, count: 30 },
        { _id: { year: 2024, month: 1, day: 17 }, count: 28 }
      ],
      courseDistribution: [
        { _id: 'Web Development', count: 35 },
        { _id: 'Data Science', count: 28 },
        { _id: 'Business Management', count: 25 }
      ]
    },
    revenue: {
      totalRevenue: 45230,
      monthlyRevenue: [
        { _id: { year: 2024, month: 1 }, estimatedRevenue: 32000 },
        { _id: { year: 2024, month: 2 }, estimatedRevenue: 35000 },
        { _id: { year: 2024, month: 3 }, estimatedRevenue: 38000 }
      ]
    }
  };
}

function updateAdvancedMetrics(data) {
  const { analytics, revenue } = data;
  
  updateKPIMetric('totalRevenue', `$${revenue?.totalRevenue?.toLocaleString() || '45,230'}`, '+12.5%');
  updateKPIMetric('totalCertificates', analytics.currentPeriod?.totalCertificates || 0, 
    `${analytics.currentPeriod?.growthRate || 0}%`);
  updateKPIMetric('totalInstitutes', '25', '+5.2%');
  updateKPIMetric('totalStudents', '1,250', '+18.7%');
  updateKPIMetric('growthRate', `${analytics.currentPeriod?.growthRate || 0}%`, '+8.3%');
  updateKPIMetric('satisfactionScore', '94.2%', '+2.1%');
}

function updateKPIMetric(id, value, change) {
  const element = document.getElementById(id);
  if (element) {
    element.textContent = value;
  }
  
  const changeElement = document.getElementById(id.replace('total', '').toLowerCase() + 'Change');
  if (changeElement) {
    changeElement.textContent = change;
    changeElement.className = `kpi-change ${change.startsWith('+') ? 'positive' : 'negative'}`;
  }
}

function updateAdvancedCharts(data) {
  const { analytics, revenue } = data;
  
  updateCertificateTrendChart(analytics);
  updateRevenueChart(revenue);
  updateCourseDistributionChart(analytics);
}

function updateCertificateTrendChart(analytics) {
  const ctx = document.getElementById('advancedCertChart');
  if (!ctx || !window.Chart) return;

  const labels = [];
  const dataPoints = [];
  
  if (analytics.dailyTrends) {
    analytics.dailyTrends.forEach(item => {
      const date = `${item._id.year}-${String(item._id.month).padStart(2, '0')}-${String(item._id.day).padStart(2, '0')}`;
      labels.push(date);
      dataPoints.push(item.count);
    });
  }

  if (chartInstances.advancedCertChart) {
    chartInstances.advancedCertChart.destroy();
  }

  chartInstances.advancedCertChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Daily Certificates',
        data: dataPoints,
        borderColor: '#667eea',
        backgroundColor: 'rgba(102, 126, 234, 0.1)',
        tension: 0.4,
        fill: true,
        pointRadius: 4,
        pointHoverRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { 
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(0,0,0,0.8)',
          titleColor: '#fff',
          bodyColor: '#fff'
        }
      },
      scales: {
        y: { 
          beginAtZero: true, 
          grid: { color: 'rgba(0,0,0,0.1)' },
          ticks: { color: '#6c757d' }
        },
        x: { 
          grid: { color: 'rgba(0,0,0,0.1)' },
          ticks: { color: '#6c757d' }
        }
      }
    }
  });
}

function updateRevenueChart(revenue) {
  const ctx = document.getElementById('revenueChart');
  if (!ctx || !window.Chart) return;

  const labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
  const dataPoints = revenue?.monthlyRevenue?.map(item => item.estimatedRevenue) || [32000, 35000, 38000, 42000, 45230, 48000];

  if (chartInstances.revenueChart) {
    chartInstances.revenueChart.destroy();
  }

  chartInstances.revenueChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Monthly Revenue',
        data: dataPoints,
        borderColor: '#28a745',
        backgroundColor: 'rgba(40, 167, 69, 0.1)',
        tension: 0.4,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { 
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(0,0,0,0.8)',
          titleColor: '#fff',
          bodyColor: '#fff'
        }
      },
      scales: {
        y: { 
          beginAtZero: true, 
          grid: { color: 'rgba(0,0,0,0.1)' },
          ticks: { color: '#6c757d' }
        },
        x: { 
          grid: { color: 'rgba(0,0,0,0.1)' },
          ticks: { color: '#6c757d' }
        }
      }
    }
  });
}

function updateCourseDistributionChart(analytics) {
  const ctx = document.getElementById('courseChart');
  if (!ctx || !window.Chart) return;

  const labels = [];
  const dataPoints = [];
  
  if (analytics.courseDistribution) {
    analytics.courseDistribution.slice(0, 6).forEach(course => {
      labels.push(course._id);
      dataPoints.push(course.count);
    });
  }

  if (chartInstances.courseChart) {
    chartInstances.courseChart.destroy();
  }

  chartInstances.courseChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{
        data: dataPoints,
        backgroundColor: [
          '#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe'
        ],
        borderWidth: 3,
        borderColor: '#fff',
        hoverOffset: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { 
        legend: { 
          position: 'bottom',
          labels: { color: '#6c757d' }
        },
        tooltip: {
          backgroundColor: 'rgba(0,0,0,0.8)',
          titleColor: '#fff',
          bodyColor: '#fff'
        }
      }
    }
  });
}

function initializeCharts() {
  // Initialize charts with empty data
  const emptyData = {
    analytics: { dailyTrends: [], courseDistribution: [] },
    revenue: { monthlyRevenue: [] }
  };
  
  updateAdvancedCharts(emptyData);
}

function populateInstituteFilter() {
  const filter = document.getElementById('instituteFilter');
  if (!filter) return;

  // Add sample institutes
  const institutes = ['Tech Academy', 'Data Institute', 'AI University', 'Security College', 'Cloud Academy'];
  institutes.forEach(inst => {
    const option = document.createElement('option');
    option.value = inst;
    option.textContent = inst;
    filter.appendChild(option);
  });
}

// Enhanced Certificate Generation
async function generateCertificate() {
  const form = document.getElementById('generateCertForm');
  if (!form) return;

  try {
    showLoadingState();
    
    const formData = new FormData(form);
    const certificateData = {
      student: formData.get('studentName') || document.getElementById('studentNameSelect')?.value,
      course: formData.get('course') || document.getElementById('studentCourseDisplay')?.value,
      institute: formData.get('institute') || document.getElementById('instituteSelect')?.value,
      date: formData.get('date') || document.getElementById('issueDate')?.value,
      uuid: generateUUID(),
      generatedByAdmin: true
    };

    const response = await authFetch(`${API_BASE}/certificates`, {
      method: 'POST',
      body: JSON.stringify(certificateData)
    });

    if (response.ok) {
      const result = await response.json();
      showSuccessMessage('Certificate generated successfully!');
      
      // Update real-time metrics
      updateDashboardMetrics({ totalCertificates: parseInt(document.getElementById('certCount')?.textContent || 0) + 1 });
      
      // Generate certificate preview
      generateCertificatePreview(result.certificate);
    } else {
      const error = await response.json();
      showErrorMessage(error.message || 'Failed to generate certificate');
    }
  } catch (error) {
    console.error('Certificate generation error:', error);
    showErrorMessage('Server error while generating certificate');
  } finally {
    hideLoadingState();
  }
}

function generateUUID() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    const r = Math.random() * 16 | 0;
    const v = c == 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

function generateCertificatePreview(certificate) {
  const preview = document.getElementById('certificatePreview');
  if (!preview) return;

  preview.innerHTML = `
    <div class="certificate-preview" style="background-color: #fffbe6; padding: 20px; border-radius: 8px; margin-top: 20px;">
      <h3>Certificate Preview</h3>
      <p><strong>Student:</strong> ${certificate.student}</p>
      <p><strong>Course:</strong> ${certificate.course}</p>
      <p><strong>Institute:</strong> ${certificate.institute}</p>
      <p><strong>Date:</strong> ${certificate.date}</p>
      <p><strong>UUID:</strong> ${certificate.uuid}</p>
    </div>
  `;
}

// Utility Functions
function showLoadingState() {
  document.body.classList.add('loading');
}

function hideLoadingState() {
  document.body.classList.remove('loading');
}

function showSuccessMessage(message) {
  const notification = document.createElement('div');
  notification.className = 'success-notification';
  notification.textContent = message;
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: #28a745;
    color: white;
    padding: 16px 24px;
    border-radius: 8px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.2);
    z-index: 1000;
    animation: slideIn 0.3s ease-out;
  `;

  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.remove();
  }, 3000);
}

function showErrorMessage(message) {
  const notification = document.createElement('div');
  notification.className = 'error-notification';
  notification.textContent = message;
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: #dc3545;
    color: white;
    padding: 16px 24px;
    border-radius: 8px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.2);
    z-index: 1000;
    animation: slideIn 0.3s ease-out;
  `;

  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.remove();
  }, 5000);
}

// Add missing validation method functions for dashboard-enhanced.js
function switchValidationMethod(method) {
  // Hide all validation panels
  document.querySelectorAll('.validation-panel').forEach(panel => {
    panel.classList.remove('active');
  });
  
  // Remove active class from all tab buttons
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // Show selected panel and activate button
  const panel = document.getElementById(method + 'Validation');
  const button = document.querySelector(`[onclick="switchValidationMethod('${method}')"]`);
  
  if (panel) panel.classList.add('active');
  if (button) button.classList.add('active');
}

function startQRScan() {
  const resultDiv = document.getElementById('validateResult');
  resultDiv.innerHTML = `
    <div style="padding:16px;border-radius:12px;background:#fff3cd;color:#856404;">
      <b>üì± QR Scanner</b><br>
      <span>QR scanning functionality will be implemented here.</span>
    </div>
  `;
}

function bulkValidate() {
  const resultDiv = document.getElementById('validateResult');
  resultDiv.innerHTML = `
    <div style="padding:16px;border-radius:12px;background:#d1ecf1;color:#0c5460;">
      <b>üìã Bulk Validation</b><br>
      <span>Bulk validation functionality will be implemented here.</span>
    </div>
  `;
}

function validateHistory() {
  const resultDiv = document.getElementById('validateResult');
  resultDiv.innerHTML = `
    <div style="padding:16px;border-radius:12px;background:#d1ecf1;color:#0c5460;">
      <b>üìú Validation History</b><br>
      <span>Validation history functionality will be implemented here.</span>
    </div>
  `;
}

async function authFetch(url, options = {}) {
  const token = localStorage.getItem('jwtToken');
  const headers = Object.assign({ 'Content-Type': 'application/json' }, options.headers || {});
  if (token) headers['Authorization'] = `Bearer ${token}`;
  
  try {
    const res = await fetch(url, { ...options, headers });
    if (res.status === 401) {
      logout();
      return Promise.reject(new Error('Unauthorized'));
    }
    return res;
  } catch (error) {
    console.error('Network error:', error);
    return Promise.reject(error);
  }
}

// Initialize dashboard when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
  initializeRealTimeDashboard();
  
  // Set up form handlers
  const generateForm = document.getElementById('generateCertForm');
  if (generateForm) {
    generateForm.addEventListener('submit', (e) => {
      e.preventDefault();
      generateCertificate();
    });
  }
});

// Make functions globally available
window.validateCertificate = validateCertificate;
window.generateAdvancedReport = generateAdvancedReport;
window.generateCertificate = generateCertificate;
